{% extends "base.html" %}

{% block title %}Status Map - MIT-WPU Vyas Tracker{% endblock %}

{% block content %}
<!-- Status Map Header -->
<section class="status-map-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="status-map-title">
                    <i class="bi bi-map me-2"></i>Live Status Map
                </h1>
                <p class="status-map-subtitle">Real-time view of room status across Vyas Building</p>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Status Legend -->
<section class="status-legend-section">
    <div class="container">
        <div class="legend-bar">
            <span class="legend-title">Status:</span>
            <span class="legend-item">
                <span class="legend-dot normal"></span>
                <span>Normal</span>
            </span>
            <span class="legend-item">
                <span class="legend-dot issue"></span>
                <span>Issue Reported</span>
            </span>
            <span class="legend-item">
                <span class="legend-dot selected"></span>
                <span>Selected</span>
            </span>
            <span class="legend-divider"></span>
            <span class="legend-title">Room Types:</span>
            <span class="legend-item">
                <span class="legend-box class"></span>
                <span>Classroom</span>
            </span>
            <span class="legend-item">
                <span class="legend-box lab"></span>
                <span>Lab</span>
            </span>
            <span class="legend-item">
                <span class="legend-box washroom"></span>
                <span>Washroom</span>
            </span>
        </div>
    </div>
</section>

<!-- Floor Selection -->
<section class="floor-tabs-section">
    <div class="container">
        <div class="floor-tabs">
            {% for floor in floors %}
            <a href="{{ url_for('admin.status_map', floor=floor.id) }}" 
               class="floor-tab {% if selected_floor and selected_floor.id == floor.id %}active{% endif %}">
                {{ floor.name }}
                {% if floor.level == 4 %}<span class="tab-badge">Demo</span>{% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Floor Map -->
<section class="floor-map-section">
    <div class="container">
        {% if selected_floor %}
        <div class="floor-map-wrapper fade-in">
            <div class="floor-map-header">
                <h4 class="mb-0">{{ selected_floor.name }}</h4>
                <span class="room-count">{{ rooms|length }} rooms</span>
            </div>
            
            <!-- Interactive Floor Map -->
            <div class="vyas-floor-map" id="vyasFloorMap">
                {% if selected_floor.level == 4 %}
                <!-- 4th Floor Layout (as per image) -->
                <div class="floor-layout detailed">
                    <!-- Top Section -->
                    <div class="map-section top-section">
                        <div class="room-block large-classroom" data-room="VY424" data-type="class">
                            <span class="room-label">VY424</span>
                            <span class="room-type">Classroom</span>
                        </div>
                        <div class="room-block lab-room" data-room="VY422" data-type="lab">
                            <span class="room-label">VY422</span>
                            <span class="room-type">Lab</span>
                        </div>
                    </div>
                    
                    <!-- Main Corridor -->
                    <div class="main-corridor">
                        <!-- Left Wing -->
                        <div class="wing left-wing">
                            <div class="room-block classroom" data-room="VY401" data-type="class">
                                <span class="room-label">VY401</span>
                            </div>
                            <div class="room-block classroom" data-room="VY402" data-type="class">
                                <span class="room-label">VY402</span>
                            </div>
                            <div class="room-block classroom" data-room="VY403" data-type="class">
                                <span class="room-label">VY403</span>
                            </div>
                            <div class="room-block classroom" data-room="VY404" data-type="class">
                                <span class="room-label">VY404</span>
                            </div>
                        </div>
                        
                        <!-- Center Block (Labs) -->
                        <div class="center-block">
                            <div class="room-block lab" data-room="VY426" data-type="lab">
                                <span class="room-label">VY426</span>
                            </div>
                            <div class="room-block lab" data-room="VY427" data-type="lab">
                                <span class="room-label">VY427</span>
                            </div>
                            <div class="room-block lab" data-room="VY428" data-type="lab">
                                <span class="room-label">VY428</span>
                            </div>
                            <div class="room-block lab" data-room="VY429" data-type="lab">
                                <span class="room-label">VY429</span>
                            </div>
                        </div>
                        
                        <!-- Right Wing -->
                        <div class="wing right-wing">
                            <div class="room-block classroom" data-room="VY414" data-type="class">
                                <span class="room-label">VY414</span>
                            </div>
                            <div class="room-block classroom" data-room="VY413" data-type="class">
                                <span class="room-label">VY413</span>
                            </div>
                            <div class="room-block washroom" data-room="VY-WC-1" data-type="washroom">
                                <span class="room-label">WC</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Corridor Label -->
                    <div class="corridor-label">Main Corridor</div>
                </div>
                {% else %}
                <!-- Generic Floor Layout for other floors -->
                <div class="floor-layout generic">
                    <div class="generic-grid">
                        {% for room in rooms %}
                        <div class="room-block {{ room.room_type }}" 
                             data-room="{{ room.number }}" 
                             data-type="{{ room.room_type }}"
                             data-room-id="{{ room.id }}">
                            <span class="room-label">{{ room.number }}</span>
                            {% if room.name %}
                            <span class="room-type">{{ room.name }}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Floor Stats -->
            <div class="floor-stats">
                {% set issue_rooms = rooms|selectattr('status', 'equalto', 'issue')|list %}
                <div class="stat-item">
                    <span class="stat-value">{{ rooms|length }}</span>
                    <span class="stat-label">Total Rooms</span>
                </div>
                <div class="stat-item issues">
                    <span class="stat-value">{{ issue_rooms|length }}</span>
                    <span class="stat-label">With Issues</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ rooms|length - issue_rooms|length }}</span>
                    <span class="stat-label">Normal</span>
                </div>
            </div>
        </div>
        
        <!-- Room Details Panel -->
        <div class="room-details-panel" id="roomDetailsPanel" style="display: none;">
            <div class="panel-header">
                <h5 id="panelRoomNumber">Room Details</h5>
                <button class="btn-close" onclick="closeRoomDetails()"></button>
            </div>
            <div class="panel-body" id="panelBody">
                <!-- Dynamic content -->
            </div>
        </div>
        {% else %}
        <div class="empty-state-card text-center py-5 fade-in">
            <i class="bi bi-building display-1 text-muted"></i>
            <h4 class="mt-4">Select a Floor</h4>
            <p class="text-muted">Choose a floor from the tabs above to view the status map</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Room Issues Summary -->
{% if selected_floor %}
<section class="issues-summary-section">
    <div class="container">
        <div class="issues-card">
            <h5 class="issues-header">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Rooms with Issues on {{ selected_floor.name }}
            </h5>
            {% set issue_rooms = rooms|selectattr('status', 'equalto', 'issue')|list %}
            {% if issue_rooms %}
            <div class="row g-3">
                {% for room in issue_rooms %}
                <div class="col-md-4 col-lg-3">
                    <div class="issue-room-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="room-number">{{ room.number }}</strong>
                                <small class="d-block text-muted">{{ room.room_type|title }}</small>
                            </div>
                            <span class="badge bg-danger">Issue</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Open Tickets: {{ room.tickets|selectattr('status', 'in', ['open', 'in-progress'])|list|length }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-check-circle text-success display-4"></i>
                <p class="mt-2 text-muted">All rooms on this floor are in normal condition</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Floor map interactions
    document.addEventListener('DOMContentLoaded', function() {
        const roomBlocks = document.querySelectorAll('.room-block');
        
        roomBlocks.forEach(block => {
            block.addEventListener('click', function() {
                const roomNumber = this.dataset.room;
                const roomId = this.dataset.roomId;
                showRoomDetails(roomNumber, roomId);
            });
        });
        
        // Highlight rooms with issues
        highlightIssueRooms();
    });
    
    function highlightIssueRooms() {
        // This would be populated from server data
        // For now, we rely on CSS classes added server-side
    }
    
    function showRoomDetails(roomNumber, roomId) {
        const panel = document.getElementById('roomDetailsPanel');
        const panelTitle = document.getElementById('panelRoomNumber');
        const panelBody = document.getElementById('panelBody');
        
        panelTitle.textContent = roomNumber;
        
        // Fetch room details
        if (roomId) {
            fetch(`/api/room/${roomNumber}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const room = data.room;
                        panelBody.innerHTML = `
                            <p><strong>Floor:</strong> ${room.floor_name}</p>
                            <p><strong>Type:</strong> ${room.room_type}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${room.status === 'issue' ? 'danger' : 'success'}">${room.status === 'issue' ? 'Issue' : 'Normal'}</span></p>
                            <a href="{{ url_for('admin.dashboard') }}?floor=${room.floor_id}" class="btn btn-sm btn-primary">
                                View Tickets
                            </a>
                        `;
                    }
                });
        } else {
            panelBody.innerHTML = '<p class="text-muted">No additional details available</p>';
        }
        
        panel.style.display = 'block';
    }
    
    function closeRoomDetails() {
        document.getElementById('roomDetailsPanel').style.display = 'none';
    }
</script>
{% endblock %}
